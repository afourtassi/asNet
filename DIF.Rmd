---
title: "ASD vs. TD DIF"
author: "George"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(kableExtra)
```


## Clean ASD CDI:WS data

```{r clean-asd-ws, eval=F}
data_AS_WS <- read.delim("data/ASD CDI data/mci_sentences02.txt", header = TRUE, sep = "\t", dec = ".")

# extracting first row as a descriptive dataframe
description_WS <- data_AS_WS[1:1,]
description_WS <- as.data.frame(t(description_WS))
names(description_WS) <- "description"


# what we get rid of:
eliminated_WS <- data_AS_WS %>%
  dplyr::select(c(701:709,780:850)) %>%
  slice(1:1) %>%
  gather(key = "Column names", value = "Description")#%>%
  #head(10)

# grammar items (past tense, future, not present, etc.)
description_WS[701:709,]
# complexity and examples (e.g. longest sentences)
description_WS[780:850,]

#using mci_sentences02_id	as a distinctive id and The NDAR Global Unique Identifier 
data_raw_AS_WS <- data_AS_WS %>%
  dplyr::select(c("mci_sentences02_id","subjectkey","interview_age", 21:779)) %>% # starting from 785 is complexity. we kept vocabs, word endings, word forms.
  dplyr::select(-(684:692))

colnames(data_raw_AS_WS) <- as.character(unlist(data_raw_AS_WS[1,])) #unlist the row
data_raw_AS_WS = data_raw_AS_WS[-1, ]

data_raw_AS_WS <- data_raw_AS_WS %>%
  rename(id = "mci_sentences02_id",
         GUID = "The NDAR Global Unique Identifier (GUID) for research subject", 
         age = "Age in months at the time of the interview/test/sampling/imaging.")%>%
  mutate(age = as.numeric(as.character(age)))

data_clean_AS_WS <- data_raw_AS_WS %>%
  gather(key = "definition", value = "value", -c(id,GUID,age))%>%
  separate(definition, c("category","definition"),sep = "\\. ") %>%
  mutate_all(na_if,"",)%>% #if blank then fill in NA
   mutate(value = ifelse(value == 0, FALSE, TRUE))

data_all_AS_WS <- data_clean_AS_WS %>%
     group_by(category, definition, age) %>%
       summarise(num_true = sum(value, na.rm = TRUE),
                 num_false = n() - num_true,
                 prop = num_true/n())


data_clean_AS_WS <- data_clean_AS_WS %>% filter(category!="Word forms, noun", 
                                                category!="Word forms, verbs",
                                                category!="Word endings, nouns",
                                                category!="Word endings, verbs") %>%
  mutate(category = case_when(category=="Sound Effects and Animal Sounds" ~ "sounds",
                              category=="Animals (Real or Toy)" ~ "animals",
                              category=="Vehicles (Real or Toy)" ~ "vehicles",
                              category=="Food and Drink" ~ "food_drink",
                              category=="Clothinq" ~ "clothing",
                              category=="Body Parts" ~ "body_parts",
                              category=="Small Household Items" ~ "household",
                              category=="Furniture and Rooms" ~ "furniture_rooms",
                              category=="Outside Thlnqs" ~ "outside",
                              category=="Action Words" ~ "action_words",
                              category=="Places to Go" ~ "places",
                              category=="Helping Verbs" ~ "helping_verbs",
                              category=="Connectinq Words" ~ "connecting_words",
                              category=="Descriptive Words" ~ "descriptive_words",
                              category=="Words About Time" ~ "time_words",
                              category=="Quantifiers and Articles" ~ "quantifiers",
                              category=="Games and Routines" ~ "games_routines",
                              category=="Question Words" ~ "question_words",
                              category=="Prepositions and Locations" ~ "locations",
                              category=="Helpinq Verbs" ~ "helping_verbs",
                              TRUE ~ category)) %>%
  mutate(category = tolower(category), 
         definition = case_when(definition=="baa" ~ "baa baa",
                                definition=="cockadoodle" ~ "cockadoodledoo",
                                definition=="quack" ~ "quack quack",
                                definition=="uhoh" ~ "uh oh",
                                definition=="woof" ~ "woof woof",
                                definition=="yum" ~ "yum yum",
                                definition=="chicken" & category=="food_drink" ~ "chicken (food)",
                                definition=="chicken" ~ "chicken (animal)",
                                definition=="fish" & category=="food_drink" ~ "fish (food)",
                                definition=="fish" ~ "fish (animal)",
                                definition=="playdough" ~ "play dough",
                                definition=="vagina" ~ "vagina*",
                                definition=="penis" ~ "penis*",
                                definition=="frenchfries" ~ "french fries",
                                definition=="greenbeans" ~ "green beans",
                                definition=="toy" ~ "toy (object)",
                                definition=="drink" & category=="action_words" ~ "drink (action)",
                                definition=="drink" ~ "drink (beverage)",
                                definition=="gasstation" ~ "gas station",
                                definition=="orange" & category=="food_drink" ~ "orange (food)",
                                definition=="orange" ~ "orange (description)",
                                definition=="allgone" ~ "all gone",
                                definition=="water" & category=="food_drink" ~ "water (beverage)",
                                definition=="water" ~ "water (not beverage)",
                                definition=="feet" ~ "foot",
                                definition=="callph" ~ "call (on phone)",
                                definition=="clean" & category=="action_words" ~ "clean (action)",
                                definition=="clean" ~ "clean (description)",
                                definition=="owie  booboo" ~ "owie/boo boo",
                                definition=="dont" ~ "don't",
                                definition=="5bowl" ~ "bowl",
                                definition=="can" & category=="household" ~ "can (object)",
                                definition=="can" & category=="helping_verbs" ~ "can (auxiliary)",
                                definition=="rockingchair" ~ "rocking chair",
                                definition=="alot" ~ "a lot",
                                definition=="buttocks/bottom" ~ "buttocks/bottom*",
                                definition=="daddy" ~ "daddy*",
                                definition=="childname" ~ "child's own name",
                                definition=="washingmachine" ~ "washing machine",
                                definition=="try" ~ "try/try to",
                                definition=="work" & category=="places" ~ "work (place)",
                                definition=="work" ~ "work (action)",
                                definition=="giveme five" ~ "give me five!",
                                definition=="mommy" ~ "mommy*",
                                definition=="grandma" ~ "grandma*",
                                definition=="church" ~ "church*",
                                definition=="daddy" ~ "daddy*",
                                definition=="grandpa" ~ "grandpa*",
                                definition=="patty cake" ~ "pattycake",
                                definition=="dry" & category=="action_words" ~ "dry (action)",
                                definition=="dry" ~ "dry (description)",
                                definition=="lemme" ~ "lemme/let me",
                                definition=="tissklee" ~ "tissue/kleenex",
                                definition=="did" ~ "did/did ya",
                                definition=="gonna get  you" ~ "gonna get you!",
                                definition=="peanutbutter" ~ "peanut butter",
                                definition=="playpen" ~ "play pen",
                                definition=="potatochip" ~ "potato chip",
                                definition=="wanna" ~ "wanna/want to",
                                definition=="watch" & category=="action_words" ~ "watch (action)",
                                definition=="watch" ~ "watch (object)",
                                definition=="dress" ~ "dress (object)",
                                definition=="gonna" ~ "gonna/going to",
                                definition=="gotta" ~ "gotta/got to",
                                definition=="hafta" ~ "hafta/have to",
                                definition=="highchair" ~ "high chair",
                                definition=="lawnmower" ~ "lawn mower",
                                definition=="little" ~ "little (description)",
                                definition=="petname" ~ "pet's name",
                                definition=="so big" ~ "so big!",
                                definition=="need" ~ "need/need to",
                                definition=="shush" ~ "shh/shush/hush",
                                definition=="swing" & category=="action_words" ~ "swing (action)",
                                definition=="swing" ~ "swing (object)",
                                definition=="slide" & category=="action_words" ~ "slide (action)",
                                definition=="slide" ~ "slide (object)",
                                TRUE ~ definition))

save(data_clean_AS_WS, file="data/ASD_WS.Rdata")

summary(data_all_AS_WS)
```


## Clean ASD CDI:WG data

Note: found a problem in the NDAR description file -- mcg_vc18_back is given the definition "backyard" (making a duplicate) instead of "back".
Also, "throw" (col 517) was left out of previous semantic network growth analyses.

```{r clean-asd-wg, eval=F}
data_AS_WG <- read.delim("data/ASD CDI data/mci_words_gestures01.txt", header = TRUE, sep = "\t", dec = ".")

# extracting first row as a descriptive dataframe
description_WG <- data_AS_WG[1:1,]
description_WG <- as.data.frame(t(description_WG))
names(description_WG) <- "description"

# we only kept vocab 
eliminated_WG <- data_AS_WG %>%
  dplyr::select(c(23:58,454:520))

#using mci_words_gestures01_id as a distinctive id and The NDAR Global Unique Identifier 

data_raw_AS_WG <- data_AS_WG %>%
  dplyr::select(c("mci_words_gestures01_id","subjectkey","interview_age", 59:453, 517))

colnames(data_raw_AS_WG) <- as.character(unlist(data_raw_AS_WG[1,])) #unlist the row
data_raw_AS_WG = data_raw_AS_WG[-1, ]

# what are the duplicated
AS_WG_duplicated <- data_raw_AS_WG[duplicated(colnames(data_raw_AS_WG))] # can call colnames 

# making column names unique
names(data_raw_AS_WG) <- make.unique(names(data_raw_AS_WG), sep="_")


data_raw_AS_WG <- data_raw_AS_WG %>%
  rename(id = "mci_words_gestures01_id",
         GUID = "The NDAR Global Unique Identifier (GUID) for research subject", 
         age = "Age in months at the time of the interview/test/sampling/imaging.",
         house = "MacArthur Words and Gestures: Vocabulary Checklist: House") %>%
  mutate(age = as.numeric(as.character(age)))


data_clean_AS_WG <- data_raw_AS_WG %>%
  gather(key = "definition", value = "value", -c(id,GUID,age)) %>%
  #separate(definition, c("category","definition"),sep = "\\. ") %>%
  mutate_all(na_if,"",) %>% #if blank then fill in NA
   mutate(value = ifelse(value == 0, FALSE, TRUE))

data_all_AS_WG <- data_clean_AS_WG %>%
     group_by(definition, age) %>%
       summarise(num_true = sum(value, na.rm = TRUE),
                 num_false = n() - num_true,
                 prop= num_true/n())

data_clean_AS_WG <- data_clean_AS_WG %>% 
  mutate(definition = case_when(
    definition=="bye or bye bye" ~ "bye",
    definition=="chicken" ~ "chicken (animal)",
    definition=="chicken_1" ~ "chicken (food)",
    definition=="peek-a-boo" ~ "peekaboo",
    definition=="water" ~ "water (beverage)",
    definition=="water_1" ~ "water (not beverage)",
    definition=="church" ~ "church*",
    definition=="clean" ~ "clean (action)",
    definition=="clean_1" ~ "clean (description)",
    definition=="daddy" ~ "daddy*",
    definition=="dress" ~ "dress (object)",
    definition=="towl" ~ "towel",
    definition=="grandpa" ~ "grandpa*",
    definition=="grandma" ~ "grandma*",
    definition=="mommy" ~ "mommy*",
    definition=="owie/ boo boo" ~ "owie/boo boo",
    definition=="little" ~ "little (description)",
    definition=="drink" ~ "drink (beverage)",
    definition=="drink_1" ~ "drink (action)",
    definition=="dry" ~ "dry (description)",
    definition=="fire truck" ~ "firetruck",
    definition=="fish" ~ "fish (animal)",
    definition=="fish_1" ~ "fish (food)",
    definition=="toy" ~ "toy (object)",
    definition=="teddy bear" ~ "teddybear",
    definition=="swing" ~ "swing (object)",
    definition=="swing_1" ~ "swing (action)",
    definition=="work" ~ "work (place)",
    definition=="orange" ~ "orange (food)",
    definition=="patty cake" ~ "pattycake",
    definition=="slide" ~ "slide (object)",
    definition=="watch" ~ "watch (object)",
    definition=="watch_1" ~ "watch (action)",
    definition=="backyard_1" ~ "back", # "mcg_vc18_back"
    TRUE ~ definition
  ))


save(data_clean_AS_WG, file="data/ASD_WG.Rdata")

summary(data_all_AS_WG)
```


```{r load-asd-data}
load("data/ASD_WS.Rdata") # data_clean_AS_WS
load("data/ASD_WG.Rdata") # data_clean_AS_WG

asd_ws <- data_clean_AS_WS %>% group_by(id, age) %>%
  summarise(production = sum(value, na.rm=T))

asd_wg <- data_clean_AS_WG %>% group_by(id, age) %>%
  summarise(production = sum(value, na.rm=T))

# remove extreme ages
data_clean_AS_WS <- data_clean_AS_WS %>%
  filter(age>=12, age<=48)

data_clean_AS_WG <- data_clean_AS_WG %>%
  filter(age>=8, age<=36)
```

Note that there are many CDI:WS administrations for ASD children outside the intended age range (16-30 months): `r nrow(subset(asd_ws, age<16))` children aged <16 months (mean production = `r round(mean(subset(asd_ws, age<16)$production), 0)` words), and `r nrow(subset(asd_ws, age>30))` children aged >30 months (mean production = `r round(mean(subset(asd_ws, age>30)$production), 0)` words).

Similarly, there are many CDI:WG administrations for ASD children outside the intended age range (8-16 months): `r nrow(subset(asd_wg, age<8))` children aged <8 months (mean production = `r round(mean(subset(asd_wg, age<8)$production), 0)` words), and `r nrow(subset(asd_wg, age>16))` children aged >16 months (mean production = `r round(mean(subset(asd_wg, age>16)$production), 0)` words).

We will constrain our analysis to those children close to the intended age ranges, extending a wider margin for older children to capture the attenuated language learning of children with ASD.
Thus, for the CDI:WS we include `r nrow(subset(asd_ws, age>=12 & age<=48))` children aged 12-48 months (removing only `r round(100*(nrow(asd_ws) - nrow(subset(asd_ws, age>=12 & age<=48)))/nrow(asd_ws),1)`% of the data).
For the CDI:WG we include `r nrow(subset(asd_wg, age>=8 & age<=36))` children aged 8-36 months (removing only `r round(100*(nrow(asd_wg) - nrow(subset(asd_wg, age>=8 & age<=36)))/nrow(asd_wg),1)`% of the data).


## Load Typically-Developing Data


```{r load-wordbank-data}
# CDI:WS
base::load("data/eng_ws_raw_data.Rds")

d_ws <- eng_ws %>%
  mutate(produces = value == "produces") %>%
  filter(!is.na(category)) %>% 
  dplyr::select(data_id, produces, age, production, sex, ethnicity, mom_ed, category, definition) %>%
  mutate(form="WS")

wb_items = d_ws %>% distinct(category, definition)

asd_items = data_clean_AS_WS %>% distinct(category, definition)

# match ASD and wordbank defs:
#intersect(wb_items$definition, asd_items$definition)
#sort(setdiff(wb_items$definition, asd_items$definition))
#sort(setdiff(asd_items$definition, wb_items$definition))


#setdiff(wb_items$category, asd_items$category)
#setdiff(asd_items$category, wb_items$category)
```

## DIF Analysis for WS data

```{r}

td_mat <- d_ws %>% dplyr::select(data_id, definition, produces) %>% 
  pivot_wider(id_cols = data_id, names_from = definition, values_from = produces)
  

asd_mat <- data_clean_AS_WS %>% rename(data_id=id) %>%
  dplyr::select(data_id, definition, value) %>% 
  pivot_wider(id_cols = data_id, names_from = definition, values_from = value)

demo_td <- d_ws %>% distinct(data_id, age, production, sex, ethnicity, mom_ed) %>% 
  mutate(group = "TD")
demo_asd <- data_clean_AS_WS %>% rename(data_id=id) %>%
  mutate(data_id = as.numeric(data_id),
         group = "ASD") %>%
  group_by(data_id, age, group) %>%
  summarise(production = sum(value, na.rm=T)) 

#cor.test(demo_asd$age, demo_asd$production) # .40
#cor.test(demo_td$age, demo_td$production) # .75

# no overlap in data_ids, right?
#intersect(demo_td$data_id, demo_asd$data_id) # 0 - good

bad_Ss_td = demo_td[which(demo_td$production==0),]$data_id 
bad_Ss_asd = demo_asd[which(demo_asd$production==0),]$data_id 

# combine data
d_mat <- rbind(td_mat, asd_mat) %>% filter(!is.element(data_id, c(bad_Ss_asd, bad_Ss_td)))
d_demo <- demo_td %>% dplyr::select(data_id, age, group, production) %>% 
  bind_rows(demo_asd) %>%
  filter(!is.element(data_id, c(bad_Ss_asd, bad_Ss_td)))

sids = d_mat$data_id
d_mat$data_id = NULL
d_mat = data.matrix(d_mat)
row.names(d_mat) = sids

d_group = as.character(d_demo$group)

source("helper_functions/DIF_helpers.R")


```

`r length(bad_Ss_td)` typically-developing (TD) children were removed from the wordbank data (`r nrow(demo_td)` total) due to their not yet producing any words.
`r length(bad_Ss_asd)` children with ASD were removed from the NDAR data (`r nrow(demo_asd)` total) due to their not yet producing any words.

```{r}
#d_ag <- d_demo %>% group_by(age, group) %>%
#  tidyboot::tidyboot_mean(production)
require(gamlss)

d_demo <- d_demo %>% mutate(prop_produced = production / 680) %>%
   mutate(prop_produced = case_when(prop_produced == 0 ~ 0.001,
                                    prop_produced == 1 ~ 0.999,
                                    TRUE ~ prop_produced)) # can't have 1 or 0


gam_mod <- gamlss(prop_produced ~ pbm(age, lambda = 10000),
                 sigma.formula = ~ pbm(age, lambda = 10000),
                 family = BE,
                 data = d_demo)

cents <- centiles.pred(gam_mod, cent = c(90, 75, 50, 25, 10),
                       xname = "age", xvalues = 12:48) %>%
  tibble() %>% pivot_longer(2:6, names_to = "percentile", values_to = "pred") %>%
  rename(age=x)


ggplot(data=d_demo, aes(x=jitter(age))) +
  geom_point(data=d_demo, alpha=.1, aes(y=production, color=group, group=group)) + 
  geom_line(data=cents, aes(x=age, y=pred * 680, linetype = percentile)) + 
  theme_classic() + xlab("Age (months)") + ylab("Production Sumscore")
```


```{r fit-ws-model, eval=F}
mod_dev_group <- fit_mod_intuitive(d_mat, d_group)

save(mod_dev_group, file="data/prodWS_IRT_model.Rds")
```

```{r load-ws-model}
load("data/prodWS_IRT_model.Rds") # 12-48 mos ASD
#plot_glimmer(mod_dev_group, colnames(d_mat), colnames(d_mat), 
#             plotName="GLIMMER_asd_prodWS_age12-48mos")

#load("data/prodWS_IRT_model_16-48mos.Rds")
#plot_glimmer(mod_dev_group, colnames(d_mat), colnames(d_mat), 
#             plotName="GLIMMER_asd_prodWS_age16-48mos")
# doesn't make a difference whether we exclude 12-15 month-old ASD kids or not


mm_asd <- extract_group_df(mod_dev_group, groups=c("TD","ASD"))
#dif_hist <- item_difficulty_difference_histogram(mm_asd)

thresh = median(mm_asd$d_diff_abs) + 2*sd(mm_asd$d_diff_abs)
big_dif = mm_asd[which(mm_asd$d_diff_abs > thresh),]

dif_histn <- item_difficulty_difference_histogram(mm_asd, withNormal = T)
print(dif_histn)
```

The majority of items are easier for TD than for ASD children. 
We examine the extrema: items with an absolute difficulty difference of at least 2 standard deviations (|d_diff| = `r round(thresh,2)`; red dotted lines in histogram).
These `r nrow(big_dif)` extrema are listed below.

```{r}
big_dif <- big_dif %>% left_join(wb_items)

big_dif %>% arrange(d_diff) %>% 
  relocate(category, definition) %>%
  rename(d_TD=d_g1, d_ASD=d_g2) %>%
  dplyr::select(-a1, -group1, -group2) %>%
  kable(format = "html", table.attr = "style='width:50%;'", digits=2)
```

```{r}
sort(table(big_dif$category)) %>% kable(col.names=c("Category","Frequency"))
```

Mostly people and action words.

## Ability vs. Sumscore by Age

```{r, eval=F, echo=F}
d_demo <- d_demo %>% 
  left_join(tibble(data_id = rownames(d_mat), 
                   ability = fscores(mod_dev_group, method = "MAP")[,1]))
# MAP: Warning: The following factor score estimates failed to converge successfully:
#  2448,2750
```



# CDI:WG Production

```{r, echo=F}
base::load("data/eng_wg_raw_data.Rds")

d_wg <- eng_wg %>%
  mutate(produces = value == "produces") %>%
  filter(!is.na(category)) %>% 
  dplyr::select(data_id, produces, age, production, sex, ethnicity, mom_ed, category, definition) %>%
  mutate(form="WG")

wg_items = d_wg %>% distinct(category, definition)

asd_items = data_clean_AS_WG %>% distinct(definition) # category not present

# match ASD and wordbank defs:
#intersect(wg_items$definition, asd_items$definition) # 396/396
#sort(setdiff(wg_items$definition, asd_items$definition))
#sort(setdiff(asd_items$definition, wg_items$definition)) 

td_mat_wg <- d_wg %>% dplyr::select(data_id, definition, produces) %>% 
  pivot_wider(id_cols = data_id, names_from = definition, values_from = produces)
  

asd_mat_wg <- data_clean_AS_WG %>% rename(data_id=id) %>%
  dplyr::select(data_id, definition, value) %>% 
  pivot_wider(id_cols = data_id, names_from = definition, values_from = value) %>%
  relocate("throw", .after="take")

# same order?
# names(td_mat_wg)==names(asd_mat_wg)

demo_td_wg <- d_wg %>% distinct(data_id, age, production, sex, ethnicity, mom_ed) %>% 
  mutate(group = "TD")
demo_asd_wg <- data_clean_AS_WG %>% rename(data_id=id) %>%
  mutate(data_id = as.numeric(data_id),
         group = "ASD") %>%
  group_by(data_id, age, group) %>%
  summarise(production = sum(value, na.rm=T)) 


# no overlap in data_ids, right?
#intersect(demo_td_wg$data_id, demo_asd_wg$data_id) # 0 - good

bad_Ss_td = demo_td[which(demo_td$production==0),]$data_id # 9
bad_Ss_asd = demo_asd[which(demo_asd$production==0),]$data_id 

# combine data
d_mat_wg <- rbind(td_mat_wg, asd_mat_wg) %>% filter(!is.element(data_id, c(bad_Ss_asd, bad_Ss_td)))
d_demo_wg <- demo_td_wg %>% dplyr::select(data_id, age, group, production) %>% 
  bind_rows(demo_asd_wg) %>%
  filter(!is.element(data_id, c(bad_Ss_asd, bad_Ss_td)))

sids = d_mat_wg$data_id
d_mat_wg$data_id = NULL
d_mat_wg = data.matrix(d_mat_wg)
row.names(d_mat_wg) = sids

d_group = as.character(d_demo_wg$group)

```

`r length(bad_Ss_td)` typically-developing (TD) children were removed from the wordbank data (`r nrow(demo_td)` total) due to their not yet producing any words.
`r length(bad_Ss_asd)` children with ASD were removed from the NDAR data (`r nrow(demo_asd)` total) due to their not yet producing any words.


```{r plot-wg-data, echo=F}
d_demo_wg <- d_demo_wg %>% mutate(prop_produced = production / 396) %>%
   mutate(prop_produced = case_when(prop_produced == 0 ~ 0.001,
                                    prop_produced == 1 ~ 0.999,
                                    TRUE ~ prop_produced)) # can't have 1 or 0


gam_mod_wg <- gamlss(prop_produced ~ pbm(age, lambda = 10000),
                 sigma.formula = ~ pbm(age, lambda = 10000),
                 family = BE,
                 data = d_demo_wg) # Algorithm RS has not yet converged

cents_wg <- centiles.pred(gam_mod_wg, cent = c(90, 75, 50, 25, 10),
                       xname = "age", xvalues = 8:36) %>%
  tibble() %>% pivot_longer(2:6, names_to = "percentile", values_to = "pred") %>%
  rename(age=x)


ggplot(data=d_demo_wg, aes(x=jitter(age))) +
  geom_point(data=d_demo_wg, alpha=.1, aes(y=production, color=group, group=group)) + 
  geom_line(data=cents_wg, aes(x=age, y=pred * 396, linetype = percentile)) + 
  theme_classic() + xlab("Age (months)") + ylab("Production Sumscore")
```

```{r fit-wg-model, eval=F}
mod_dev_group <- fit_mod_intuitive(d_mat_wg, d_group)
# Warning: data contains response patterns with only NAs
save(mod_dev_group, file="data/prodWG_IRT_model.Rds")
```

```{r load-wg-model}
load("data/prodWG_IRT_model.Rds") # 8-36mo ASD
#plot_glimmer(mod_dev_group, colnames(d_mat_wg), colnames(d_mat_wg), 
#             plotName="GLIMMER_asd_prodWG_age8-36mos")


mm_asd_wg <- extract_group_df(mod_dev_group, groups=c("TD","ASD"))
#dif_hist <- item_difficulty_difference_histogram(mm_asd)

thresh_wg = median(mm_asd_wg$d_diff_abs) + 2*sd(mm_asd_wg$d_diff_abs)
big_dif_wg = mm_asd_wg[which(mm_asd_wg$d_diff_abs > thresh_wg),]

dif_histn_wg <- item_difficulty_difference_histogram(mm_asd_wg, withNormal = T)
print(dif_histn_wg)
```

The majority of items are easier for TD than for ASD children. 
We examine the extrema: items with an absolute difficulty difference of at least 2 standard deviations (|d_diff| = `r round(thresh_wg,2)`; red dotted lines in histogram).
These `r nrow(big_dif_wg)` extrema are listed below.

```{r}
big_dif_wg <- big_dif_wg %>% left_join(wg_items)

big_dif_wg %>% arrange(d_diff) %>% 
  relocate(category, definition) %>%
  rename(d_TD=d_g1, d_ASD=d_g2) %>%
  dplyr::select(-a1, -group1, -group2) %>%
  kable(format = "html", table.attr = "style='width:50%;'", digits=2)
```
